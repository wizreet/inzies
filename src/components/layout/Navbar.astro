---
/**
 * Navbar Component
 *
 * Main navigation component with responsive mobile menu and dropdown links.
 * Uses centralized configuration and follows accessibility best practices.
 *
 * @component
 */
import { Icon } from "astro-icon/components";
import { navConfig, siteConfig } from "@/config";
import { ROUTES, EXTERNAL_URLS, ARIA_LABELS } from "@constants/index";
import { getExternalLinkAttributes } from "@utils/url";

const currentPath = Astro.url.pathname;

/**
 * Checks if a navigation link is currently active
 * Uses normalized path comparison for accuracy
 */
function isActive(linkUrl: string): boolean {
	const normalizePath = (path: string): string => (path.endsWith("/") ? path : `${path}/`);
	return normalizePath(currentPath) === normalizePath(linkUrl);
}

/** External link attributes for security */
const externalLinkAttrs = getExternalLinkAttributes();

/** Social links configuration */
const socialLinks = [
	{ href: siteConfig.social.youtube, icon: "fa6-brands:youtube", label: "YouTube" },
	{ href: siteConfig.social.spotify, icon: "fa6-brands:spotify", label: "Spotify" },
	{ href: siteConfig.social.instagram, icon: "fa6-brands:instagram", label: "Instagram" },
	{ href: siteConfig.social.facebook, icon: "fa6-brands:facebook", label: "Facebook" },
].filter((link) => link.href);
---

<nav
	id="navbar"
	class="bg-[var(--bg-primary)]/80 fixed left-0 right-0 top-0 z-50 border-b border-[var(--border-color)] backdrop-blur-lg"
	role="navigation"
	aria-label={ARIA_LABELS.mainNavigation}
>
	<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
		<div class="flex h-[var(--header-height)] items-center justify-between">
			<!-- Logo -->
			<a
				href={ROUTES.home}
				class="group flex items-center gap-3"
				aria-label={`${siteConfig.title} - ${ARIA_LABELS.home}`}
			>
				<img
					src={`${ROUTES.home}LogoAnimations/logo-transparent.png`}
					alt={siteConfig.title}
					class="h-8 w-auto transition-transform group-hover:scale-110"
					width="32"
					height="32"
					loading="eager"
					decoding="async"
				/>
			</a>

			<!-- Desktop Navigation -->
			<div class="hidden items-center gap-1 md:flex" role="menubar">
				{
					navConfig.map((link) => (
						<a
							href={link.url}
							data-nav-link
							role="menuitem"
							aria-current={isActive(link.url) ? "page" : undefined}
							class:list={["nav-link nav-link-desktop", isActive(link.url) && "is-active"]}
						>
							{link.name}
						</a>
					))
				}
			</div>

			<!-- Right Side Actions -->
			<div class="flex items-center gap-2">
				<!-- Links Dropdown -->
				<div class="group relative hidden md:block">
					<button
						id="links-dropdown-btn"
						class="nav-link nav-link-desktop flex items-center gap-1"
						aria-expanded="false"
						aria-haspopup="true"
						aria-controls="links-dropdown-menu"
						aria-label={ARIA_LABELS.externalLinks}
					>
						Links
						<Icon
							name="material-symbols:arrow-drop-down-rounded"
							class="text-xl transition-transform group-hover:rotate-180"
							aria-hidden="true"
						/>
					</button>
					<div
						id="links-dropdown-menu"
						class="absolute right-0 mt-2 w-48 rounded-lg border border-[var(--border-color)] bg-[var(--bg-secondary)] shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200"
						role="menu"
						aria-labelledby="links-dropdown-btn"
					>
						<div class="py-2">
							{
								socialLinks.map((link) => (
									<a
										href={link.href}
										{...externalLinkAttrs}
										role="menuitem"
										class="flex items-center gap-3 px-4 py-2 transition-colors hover:bg-[var(--bg-primary)]"
										aria-label={link.label}
									>
										<Icon name={link.icon} class="text-lg" aria-hidden="true" />
										<span class="text-sm">{link.label}</span>
									</a>
								))
							}
						</div>
					</div>
				</div>

				<!-- Mobile Menu Button -->
				<button
					id="mobile-menu-btn"
					class="btn-plain h-11 w-11 rounded-lg md:hidden"
					aria-expanded="false"
					aria-controls="mobile-menu"
					aria-label={ARIA_LABELS.toggleMenu}
				>
					<Icon name="material-symbols:menu-rounded" class="text-2xl" aria-hidden="true" />
				</button>
			</div>
		</div>
	</div>

	<!-- Mobile Navigation -->
	<div
		id="mobile-menu"
		class="hidden border-t border-[var(--border-color)] md:hidden"
		role="menu"
		aria-label={ARIA_LABELS.mobileNavigation}
	>
		<div class="space-y-1 bg-[var(--bg-secondary)] px-4 py-4">
			{
				navConfig.map((link) => (
					<a
						href={link.url}
						data-nav-link
						role="menuitem"
						aria-current={isActive(link.url) ? "page" : undefined}
						class:list={["nav-link nav-link-mobile", isActive(link.url) && "is-active"]}
					>
						<span class="flex items-center gap-3">
							{link.icon && <Icon name={link.icon} class="text-xl" aria-hidden="true" />}
							{link.name}
						</span>
					</a>
				))
			}
		</div>
	</div>
</nav>

<script>
	/**
	 * Navbar client-side functionality
	 * Handles mobile menu, dropdown, and active state updates
	 */

	// DOM element references (cached for performance)
	const menuBtn = document.getElementById("mobile-menu-btn");
	const mobileMenu = document.getElementById("mobile-menu");
	const navbar = document.getElementById("navbar");
	const linksDropdownBtn = document.getElementById("links-dropdown-btn");
	const linksDropdownMenu = document.getElementById("links-dropdown-menu");

	/**
	 * Normalizes a path for comparison
	 */
	const normalizePath = (path: string): string => (path.endsWith("/") ? path : `${path}/`);

	/**
	 * Updates active navigation state based on current URL
	 */
	const updateActiveNav = (): void => {
		if (!navbar) return;

		const current = normalizePath(window.location.pathname);
		const navLinks = navbar.querySelectorAll<HTMLAnchorElement>("a[data-nav-link]");

		navLinks.forEach((link) => {
			const linkPath = normalizePath(new URL(link.href).pathname);
			const isActive = current === linkPath;

			link.classList.toggle("is-active", isActive);

			if (isActive) {
				link.setAttribute("aria-current", "page");
			} else {
				link.removeAttribute("aria-current");
			}
		});
	};

	/**
	 * Toggles mobile menu visibility
	 */
	const toggleMobileMenu = (forceClose: boolean = false): void => {
		if (!mobileMenu || !menuBtn) return;

		const isHidden = mobileMenu.classList.contains("hidden");
		const shouldShow = !forceClose && isHidden;

		mobileMenu.classList.toggle("hidden", !shouldShow);
		menuBtn.setAttribute("aria-expanded", String(shouldShow));
	};

	/**
	 * Toggles dropdown menu visibility
	 */
	const toggleDropdown = (forceClose: boolean = false): void => {
		if (!linksDropdownMenu || !linksDropdownBtn) return;

		const isHidden = linksDropdownMenu.classList.contains("hidden");
		const shouldShow = !forceClose && isHidden;

		linksDropdownMenu.classList.toggle("hidden", !shouldShow);
		linksDropdownBtn.setAttribute("aria-expanded", String(shouldShow));
	};

	// Event listeners
	menuBtn?.addEventListener("click", () => toggleMobileMenu());

	linksDropdownBtn?.addEventListener("click", (e: MouseEvent) => {
		e.stopPropagation();
		toggleDropdown();
	});

	// Close dropdown when clicking outside
	document.addEventListener("click", (e: MouseEvent) => {
		const target = e.target as Node | null;
		if (!linksDropdownMenu?.contains(target) && !linksDropdownBtn?.contains(target)) {
			toggleDropdown(true);
		}
	});

	// Close mobile menu on link click
	mobileMenu?.querySelectorAll("a").forEach((link) => {
		link.addEventListener("click", () => toggleMobileMenu(true));
	});

	// Handle keyboard navigation for dropdown
	linksDropdownBtn?.addEventListener("keydown", (e: KeyboardEvent) => {
		if (e.key === "Escape") {
			toggleDropdown(true);
			linksDropdownBtn.focus();
		}
	});

	// Astro page transitions support
	document.addEventListener("astro:page-load", updateActiveNav);

	document.addEventListener("astro:after-swap", () => {
		updateActiveNav();
		toggleMobileMenu(true);
	});

	// Initial state
	updateActiveNav();
</script>
